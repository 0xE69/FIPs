---
fip: <to be assigned>
title: Atomic switch to non-programmable FVM
authors: Ra√∫l Kripalani (@raulk), Steven Allen (@stebalien)
discussions-to:
status: Draft
type: Technical Core
category: Core
created: 2022-02-03
spec-sections:
  - TBD
requires:
  - FIP-0030 (Introducing the Filecoin Virtual Machine)
replaces: N/A
---

# Atomic switch to non-programmable FVM

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [Simple Summary](#simple-summary)
- [Abstract](#abstract)
- [Change Motivation](#change-motivation)
- [Specification](#specification)
  - [WASM bytecode management](#wasm-bytecode-management)
  - [Warming up the module cache](#warming-up-the-module-cache)
  - [Atomic switch of execution layer](#atomic-switch-of-execution-layer)
  - [Migration procedure](#migration-procedure)
  - [Optional removal of intrinsic VM from Filecoin client codebases](#optional-removal-of-intrinsic-vm-from-filecoin-client-codebases)
  - [Actor changes](#actor-changes)
    - [Init actor](#init-actor)
    - [Power actor](#power-actor)
- [Design Rationale](#design-rationale)
- [Backwards Compatibility](#backwards-compatibility)
  - [CodeCIDs](#codecids)
  - [Non-versioned changes and state tree migrations](#non-versioned-changes-and-state-tree-migrations)
- [Test Cases](#test-cases)
- [Security Considerations](#security-considerations)
- [Incentive Considerations](#incentive-considerations)
- [Product Considerations](#product-considerations)
- [Implementation](#implementation)
- [Copyright](#copyright)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Simple Summary

This FIP proposes an **atomic switch** from the current intrinsic VM to a
**non-programmable version of the Filecoin Virtual Machine**, at a chain epoch
TBD.

A baseline specification of the Filecoin Virtual Machine is provided in
[filecoin-project/FIPs#288](https://github.com/filecoin-project/FIPs/pull/288).
Only the canonical built-in actors will be supported after the atomic switch.

This switch won't introduce new user-facing features or capabilities, but it's
an important step in the trajectory towards full on-chain user-programmability.
It also improves network security by sandboxing execution and making it
deterministic.

## Abstract

At chain height TBD, the network's execution layer will transition from the
intrinsic VM to a non-programmable version of the FVM. By _non-programmable_ we
mean that users won't be able to deploy custom code, yet.

The network will continue running the logic of the prevailing built-in actor
version, estimated to be v7 (assuming this FIP is scheduled to go live right
after nv15: OhSnap).

However, the code and deployment form of built-in actors will now be Wasm
bytecode. Actor code will begin to be identified through real
content-addressing. The current _synthetic_ actor CodeCIDs will migrate to CIDs
that hash over their actual Wasm bytecode.

## Change Motivation

Swapping out core components in the execution layer of a blockchain is a complex
operation. It's analogous to replacing the engine of an airplane while airborne.

For this reason, its advisable to manage risk carefully. Monolithic, big-bang
deployments are risky. It's appropriate to break up changes in smaller units
that can be deployed in an orderly, incremental fashion, eventually leading up
to the final goal: on-chain user-programmability.

Even though this FIP doesn't introduce user-facing features, it represents a
fundamental technological transition in the network, where a new technology
comes alive and the previous technology is decomissioned, all in a single atomic
step.

Subsequent FVM-related FIPs will introduce changes atop the foundations
installed in the network by this FIP.

## Specification

### WASM bytecode management

The WASM bytecode for built-in actors will be available within CAR files
generated by the build scripts at repo:
https://github.com/filecoin-project/canonical-actors (TBD).

These CAR files will contain one IPLD block per built-in actor. The IPLD block
will contain the bytecode in raw and full (no chunking into IPLD DAGs).

The node must load the content of these CAR files into the node's state
blockstore. These blocks will remain orphan until the migration is run at the
upgrade epoch. Thus, any form of stage garbage collection must explicitly
protect these blocks from deletion (e.g. splitstore). At migration, all actors
will be linked to their respective bytecode in the state tree.

The node must verify that exactly N blocks were loaded, with CIDs ...

### Warming up the module cache

Prior to the upgrade epoch, it is advisable for the Filecoin client to warm up
the Wasm module cache by pre-compiling the built-in actors into machine code.

### Atomic switch of execution layer

Filecoin clients must simultaneously support both execution layers:

1. The current, intrinsic VM (the source).
2. The non-programmable FVM (the target).

At upgrade epoch TBD, blocks assembled by block producers in epoch TBD-1 with
the source VM will be compiled into a tipset and be executed by all validators
**with the target VM**.

From that moment onwards, block producers will construct blocks using the target
VM. Validators will validate tipsets with target VM also. In other words, both
block production and validation will operate with the target VM.

Following one finality (900 epochs), the deprecation of the source VM will be
considered final.

> Notes:
> Should we run sanity check procedures in the epochs preceding TBD? Validating
> tipsets in parallel with both VMs; and aborting the upgrade on mismatch.

### Migration procedure

At epoch TBD, prior to executing the tipset assembled at epoch TBD-1, Filecoin
clients will run a migration over the state tree to replace the CodeCID in the
ActorState struct of every actor.

The replacement will be performed according to this replacement table:

| Old value (synthetic CID)         | New value (content-addressed CID)                     |
| --------------------------------- | ----------------------------------------------------- |
| `fil/7/system`                    | TBD                                                   |
| `fil/7/init`                      | TBD                                                   | 
| `fil/7/cron`                      | TBD                                                   |
| `fil/7/account`                   | TBD                                                   |
| `fil/7/storagepower`              | TBD                                                   |
| `fil/7/storageminer`              | TBD                                                   |
| `fil/7/storagemarket`             | TBD                                                   |
| `fil/7/paymentchannel`            | TBD                                                   |
| `fil/7/multisig`                  | TBD                                                   |
| `fil/7/reward`                    | TBD                                                   |
| `fil/7/verifiedregistry`          | TBD                                                   |

> Notes:
> What would a premigration look like here?

### Optional removal of intrinsic VM from Filecoin client codebases

After the upgrade epoch is over and one finality is attained, Filecoin clients
may choose to complete erase the current VM from their respective codebases.

Because the canonical actors codebase supports only actors v6+, in doing so they
will lose the ability to sync past portions of the chain. This may be an
undesirable loss of functionality depending on the desired UX of every client,
hence why this is entirely optional.

Alternatively, Filecoin clients may provide historical chain support by
preserving the intrinsic VM in their codebases but activating it only through
optional compilation (e.g. using Go build flags, or Rust Cargo features).

### Actor changes

#### Init actor

The init actor acts like the constructor for actor types that can be
instantiated by user messages, namely:

1. Miner actor, via the power actor.
2. Multisig actor.
3. Payment channel actor.

While this FIP introduces no changes in this behaviour, nor to the allow list
itself, the filtering logic will need to use the new content-addressed CodeCIDs
for these actors.

#### Power actor

The `CreateMiner` method (method number 2) calls the Init actor to construct a
new Miner actor. It will need to pass the new content-addressed CodeCID for the
latter.

## Design Rationale

WIP.

## Backwards Compatibility

### CodeCIDs

Changing the CodeCID of built-in actors can have visible consequences for users:

1. When constructing multisig or payment channel actors, they will need to use a
   content-addressed CodeCID (unpredicable) instead of a synthetic CID
   (predictable).
2. When querying an actor in the state tree (e.g. via the `StateGetActor`
   JSON-RPC API in Lotus), the `Code` field will no longer follow a structured
   name. This may break applications that depend on CodeCID parsing (e.g.
   statediff).

A possible solution is to implement a lookup table that maps synthetic CodeCIDs
to content-addressed CodeCIDs, and vice versa, for JSON-RPC handlers to use.

When CodeCIDs are to be returned, JSON-RPC operations can be extended with a
"legacy CodeCIDs" option for the user to demand a conversion prior to returning.

### Non-versioned changes and state tree migrations

Today, actor logic can change without its version being affected and, therefore,
without the associated CodeCIDs changing in the state tree. This is because the
actor version (e.g. actors v6) represents a version of the ABI, not of the
actor's logic.

However, with the adoption of a canonical Wasm actors codebase across the
network, _any_ and _every_ change in actor logic will result in different
bytecode. Because actor code is now truly content-addressed over the bytecode,
the CodeCIDs will change, therefore requiring a migration of all relevant actors
in the state tree where, in the past, such migration would've not been
necessary.

There is no action to take in this FIP, but it is worth noting the difference in
change management dynamics that this FIP will bring on.

## Test Cases

WIP.

## Security Considerations

WIP.

## Incentive Considerations

N/A.

## Product Considerations

WIP.

## Implementation

WIP.

## Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
